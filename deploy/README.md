# Deploying an application with the Deucalion framework 

## 1. Create an anomaly detection app using the Python framework 
Follow the instructions in the [README.md file](../framework/deucalion/README.md) of the deucalion framework to create a deuclaion sidecar application. 

Containerize your AD application. 
An example development Dockerfile can be found [here](../framework/deucalion/Dockerfile). 
An example production Dockerfile can be found [here](../framework/deucalion/example_app/Dockerfile)

## 2. Deploying the automatic sidecar injector

You can either deploy the sidecar injector using Helm, or you can do it manually. The installation with Helm is recommended. 

To automatically inject sidecars into pods, a Mutating Webhook Admission Controller is configured. The k8s api server then sends admission reviews to this webhook, which it will only do over TLS, so, in either case, you will have to manually create a TLS certificate, signed by a CA. 

### Using Helm

Follow steps 1 and 2 in this [README.md](../sidecarinjection/configuration/tls/README.md) file to generate the TLS certificate and CA bundle. 

When installing with Helm, only some values must be set to fill in the previously generated TLS values (base64 encoded). This can be done as follows: 
```
helm upgrade --install deucalion-sidecar-injection-chart-1649709429 deucalion-sidecar-injection-chart --set admissionController.webhookService.caBundle="$(base64 ../../sidecarinjection/configuration/tls/ca.pem)" --set admissionController.webhookService.tlsCrt="$(base64 ../../sidecarinjection/configuration/tls/webhook-tls.pem)" --set admissionController.webhookService.tlsKey="$(base64 ../../sidecarinjection/configuration/tls/webhook-tls-key.pem)"
```

### Manually
Installing mannually is not recommended and not supported. 

<!-- When deploying manually, the secrets have to be manually injected in the secrets file. Therefore, follow all steps in this [README.md](../sidecarinjection/configuration/tls/README.md) file to generate the TLS certificate and CA bundle and Kubernetes Secret. 


#### deploy the sidecar injector
Apply the sidecarinjection/mutatingAdmissionWebhook/deucalion-sidecar-injector-deployment.yml configuration file to k8s. 

#### add the MutatingWbhookconfiguration to k8s
Apply the webhook.yaml (containing the data generated by the previous step) file to k8s. 


## 3. Deploy your application on k8s
Label new deployments with "deucalion-sidecar-enabled: "true"", like the example deployment found in implementations/deploy/example-deployment/nodeexporter-deployment.yml. 

Add the container image name to the deployment configuration of your application. (work in progress) -->
